<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Test - Vergeside Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/admin/css/admin.css">
</head>
<body>
    <div class="container py-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Auth API Test</h4>
                    </div>
                    <div class="card-body">
                        <h5>Test Authentication API</h5>
                        <p>This page helps diagnose authentication issues with the Vergeside Admin CMS.</p>
                        
                        <div class="mb-4">
                            <h6>API Status Check</h6>
                            <button id="check-api" class="btn btn-outline-primary">Check API Status</button>
                            <div id="api-status" class="mt-2"></div>
                        </div>
                        
                        <div class="mb-4">
                            <h6>Auth0 Login Test</h6>
                            <a href="/api/auth/login" class="btn btn-primary">Test Auth0 Login</a>
                        </div>
                        
                        <div class="mb-4">
                            <h6>Authentication Status</h6>
                            <button id="check-auth" class="btn btn-outline-primary">Check Auth Status</button>
                            <div id="auth-status" class="mt-2"></div>
                        </div>
                        
                        <div class="mb-4">
                            <h6>Logout Test</h6>
                            <a href="/api/auth/logout" class="btn btn-outline-danger">Test Logout</a>
                        </div>
                        
                        <hr>
                        
                        <div class="mb-4">
                            <h6>Environment Information</h6>
                            <button id="check-env" class="btn btn-outline-secondary">Show Environment Info</button>
                            <div id="env-info" class="mt-2"></div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between">
                            <a href="/admin/index.html" class="btn btn-outline-secondary">Back to Admin</a>
                            <a href="/" class="btn btn-outline-primary">Back to Main Site</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
    <script src="/js/env-config.js"></script>
    <script src="/js/config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const apiStatus = document.getElementById('api-status');
            const authStatus = document.getElementById('auth-status');
            const envInfo = document.getElementById('env-info');
            
            const checkApiBtn = document.getElementById('check-api');
            const checkAuthBtn = document.getElementById('check-auth');
            const checkEnvBtn = document.getElementById('check-env');
            
            // Check API status
            checkApiBtn.addEventListener('click', async () => {
                apiStatus.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Checking API...';
                
                try {
                    const response = await fetch('/api/auth/debug');
                    const data = await response.json();
                    
                    if (response.ok) {
                        apiStatus.innerHTML = `
                            <div class="alert alert-success">
                                <strong>API is working!</strong><br>
                                Message: ${data.message}<br>
                                Time: ${data.time}
                            </div>
                        `;
                    } else {
                        apiStatus.innerHTML = `
                            <div class="alert alert-danger">
                                <strong>API error!</strong><br>
                                Status: ${response.status}<br>
                                Message: ${data.message || 'Unknown error'}
                            </div>
                        `;
                    }
                } catch (error) {
                    apiStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>API connection error!</strong><br>
                            Error: ${error.message}
                        </div>
                    `;
                }
            });
            
            // Check authentication status
            checkAuthBtn.addEventListener('click', async () => {
                authStatus.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Checking authentication...';
                
                try {
                    // Create Supabase client
                    const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                    
                    // Get current session
                    const { data: { session }, error } = await supabaseClient.auth.getSession();
                    
                    if (error) {
                        authStatus.innerHTML = `
                            <div class="alert alert-danger">
                                <strong>Authentication error!</strong><br>
                                Error: ${error.message}
                            </div>
                        `;
                    } else if (session) {
                        authStatus.innerHTML = `
                            <div class="alert alert-success">
                                <strong>Authenticated!</strong><br>
                                User: ${session.user.email}<br>
                                Expires: ${new Date(session.expires_at * 1000).toLocaleString()}
                            </div>
                        `;
                    } else {
                        authStatus.innerHTML = `
                            <div class="alert alert-warning">
                                <strong>Not authenticated</strong><br>
                                No active session found.
                            </div>
                        `;
                    }
                } catch (error) {
                    authStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Authentication check error!</strong><br>
                            Error: ${error.message}
                        </div>
                    `;
                }
            });
            
            // Show environment information
            checkEnvBtn.addEventListener('click', async () => {
                envInfo.innerHTML = `
                    <div class="alert alert-info">
                        <strong>Environment Information</strong><br>
                        <ul>
                            <li>URL: ${window.location.href}</li>
                            <li>User Agent: ${navigator.userAgent}</li>
                            <li>Supabase URL: ${CONFIG.SUPABASE_URL}</li>
                        </ul>
                    </div>
                `;
            });
        });
    </script>
</body>
</html>
